app-id: org.freedesktop.Sdk.Extension.dotnet
branch: '20.08'
runtime: org.freedesktop.Sdk
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
build-extension: true
separate-locales: false
appstream-compose: false
modules:
  - name: libunwind
    rm-configure: true
    build-options:
      cflags: -fcommon
      prefix: /usr/lib/sdk/dotnet
    cleanup:
      - '/include'
      - '/pkgconfig'
      - '*.a'
      - '*.la'
      - '*ptrace.so*'
      - '*setjmp.so*'
    sources:
      - type: archive
        url: https://download.savannah.nongnu.org/releases/libunwind/libunwind-1.4.0.tar.gz
        sha256: df59c931bd4d7ebfd83ee481c943edf015138089b8e50abed8d9c57ba9338435
      - type: script
        commands:
          - 'autoreconf -sif'
        dest-filename: autogen.sh

  - name: dotnet-sdk
    buildsystem: simple
    build-commands:
      - 'mkdir -p /usr/lib/sdk/dotnet/{bin,lib}'
      - 'cp -r * /usr/lib/sdk/dotnet/lib'
      - 'ln -s /usr/lib/sdk/dotnet/lib/dotnet /usr/lib/sdk/dotnet/bin/dotnet'
    sources:
      - type: archive
        only-arches: [x86_64]
        url: https://download.visualstudio.microsoft.com/download/pr/70d12135-d65f-4f4c-9d96-a6ac0251fb1b/57856b7654e338027cfb53552b2c4d46/dotnet-sdk-3.1.413-linux-x64.tar.gz
        sha512: 2a0824f11aba0b79d3f9a36af0395649bc9b4137e61b240a48dccb671df0a5b8c2086054f8e495430b7ed6c344bb3f27ac3dfda5967d863718a6dadeca951a83
      - type: archive
        only-arches: [arm]
        url: https://download.visualstudio.microsoft.com/download/pr/40edd52f-b1ca-4f0c-8d50-34433202ce9d/2b8f5b881c239a706f271f010e56159c/dotnet-sdk-3.1.413-linux-arm.tar.gz
        sha512: 31f395b1e48e9ba53d4dc63db7ff1ea38bdcb612a1d54b483cde22a009c48fbae0303779f42cee32db0e51bd953c8abfdaa1620a43a7fd84e1f8e937b6675d59
      - type: archive
        only-arches: [aarch64]
        url: https://download.visualstudio.microsoft.com/download/pr/dfd0ad22-3e47-432f-9aa1-f65b11a2ced2/d096c5d1561732c1658543fa8fb7a31f/dotnet-sdk-3.1.413-linux-arm64.tar.gz
        sha512: 39f198f07577faf81f09ca621fb749d5aac38fc05e7e6bd6226009679abc7d001454068430ddb34b320901955f42de3951e2707e01bce825b5216df2bc0c8eca

  - name: scripts
    buildsystem: simple
    build-commands:
      - 'mkdir -p /usr/lib/sdk/dotnet/share/appdata'
      - 'cp enable.sh install.sh install-sdk.sh /usr/lib/sdk/dotnet'
      - 'cp org.freedesktop.Sdk.Extension.dotnet.appdata.xml ${FLATPAK_DEST}/share/appdata'
      - 'mkdir -p /usr/lib/sdk/dotnet/share/appdata'
      - 'appstream-compose --basename=org.freedesktop.Sdk.Extension.dotnet --prefix=${FLATPAK_DEST} --origin=flatpak org.freedesktop.Sdk.Extension.dotnet'
    sources:
      - type: script
        commands:
          - 'mkdir -p /app/dotnet/{bin,lib}'
          - 'cp -L /usr/lib/sdk/dotnet/lib/libunwind{,-coredump,-$FLATPAK_ARCH}.so /app/dotnet/lib'
          - 'cp -r /usr/lib/sdk/dotnet/lib/{dotnet,host,shared} /app/dotnet/lib'
          - 'ln -s /app/dotnet/lib/dotnet /app/dotnet/bin/dotnet'
        dest-filename: install.sh
      - type: script
        commands:
          - '/usr/lib/sdk/dotnet/install.sh'
          - 'cp -r /usr/lib/sdk/dotnet/lib/sdk /app/dotnet/lib'
        dest-filename: install-sdk.sh
      - type: script
        commands:
          - 'export PATH=$PATH:/usr/lib/sdk/dotnet/bin'
          - 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/lib/sdk/dotnet/lib'
          - 'export DOTNET_CLI_TELEMETRY_OPTOUT=true'
          - 'export DOTNET_SKIP_FIRST_TIME_EXPERIENCE=true'
          - 'export DOTNET_ROOT=/usr/lib/sdk/dotnet/lib'
        dest-filename: enable.sh
      - type: file
        path: org.freedesktop.Sdk.Extension.dotnet.appdata.xml
